# Syncthing

Syncthing is used to synchronize files between SKYLAB and other devices (Laptops, Phones) in a decentralized and secure way.
The service is configured in `modules/services/syncthing.nix`.

## Configuration Reference (NixOS 25.11)

The complete list of available options for the `services.syncthing` module can be found in the [official NixOS Options Search](https://search.nixos.org/options?channel=25.11&query=services.syncthing).

## Full Configuration Template

You can use this template in `modules/services/syncthing.nix` to configure the service exhaustively:

```nix
{ config, pkgs, ... }: {
  services.syncthing = {
    enable = true;

    # Whether to create a systemd system service.
    # Default: true
    systemService = true;

    # User account under which Syncthing runs.
    # Default: "syncthing"
    user = "johndoe";

    # Group under which Syncthing runs.
    # Default: "syncthing"
    group = "users";

    # The path where synchronized folders are stored by default.
    # Default: "/var/lib/syncthing"
    dataDir = "/home/johndoe";

    # The directory where configuration and keys are stored.
    # Default: config.services.syncthing.dataDir
    configDir = "/home/johndoe/.config/syncthing";

    # The directory where the database is stored.
    # Default: config.services.syncthing.configDir
    databaseDir = "/home/johndoe/.config/syncthing";

    # The address the web interface will listen on.
    # Default: "127.0.0.1:8384" (localhost only)
    guiAddress = "127.0.0.1:8384";

    # Whether to open the default ports (22000/TCP/UDP, 21027/UDP).
    # Default: false
    openDefaultPorts = true;

    # Extra command-line arguments passed to the syncthing binary.
    extraFlags = [ ];

    # Whether to delete the devices which are not configured via the devices option.
    # If set to false, devices added via the web interface will persist and will have to be deleted manually.
    # Default: true
    overrideDevices = true;

    # Whether to delete the folders which are not configured via the folders option.
    # If set to false, folders added via the web interface will persist and will have to be deleted manually.
    # Default: true
    overrideFolders = true;

    # Declarative configuration for devices, folders, and options.
    settings = {
      # List of devices to share folders with.
      devices = {
        "DEVICE-NAME" = { id = "DEVICE-ID-HERE"; };
      };

      # List of folders to synchronize.
      folders = {
        "folder-label" = {
          path = "/path/to/folder";
          devices = [ "DEVICE-NAME" ];
          # Whether to ignore file permissions.
          ignorePerms = false;
        };
      };

      # Syncthing configuration options (config.xml)
      options = {
        # Whether to send announcements to the local LAN, also use such announcements to find other devices.
        localAnnounceEnabled = true;
        # When true, relays will be connected to and potentially used for device to device connections.
        relaysEnabled = false;
        # Usage reporting: -1 (no), 0 (not answered), >=1 (yes)
        urAccepted = -1;
      };

      # GUI settings
      gui = {
        # theme = "black";
      };
    };
  };
}
```

## Connection to the GUI

See [Remote Web GUI](https://docs.syncthing.net/users/firewall.html#remote-web-gui) for reference.

The Syncthing GUI is only accessible via an SSH tunnel.

1.  **Create an SSH Tunnel**:
    From your laptop, run:
    ```bash
    ssh -L 8385:localhost:8384 <SKYLAB_IP>
    ```
2.  **Access the Web GUI**:
    Open your browser and navigate to `http://localhost:8385`.
3.  **Identify SKYLAB**:
    Go to **Actions > Show ID**. This is the unique identifier you will need to add SKYLAB to your other devices.

## Adding syncthing to a new device (example: Fedora workstation)

1. Install syncthing using your package manager (`sudo dnf install syncthing`)
2. Generate the certificates inside the home directory of your choice

```bash
$ syncthing generate --no-default-folder
2026/01/21 14:26:08 INFO: Generating ECDSA key and certificate for syncthing...
2026/01/21 14:26:08 INFO: Device ID: XXXXXXX-XXXXXXX-XXXXXXX-XXXXXXX-..

$ tree ~/.config/syncthing/
/home/johndoe/.config/syncthing/
├── cert.pem
├── config.xml
└── key.pem
```

3. Launch the configuration to tweak the configuration and add folders
```bash
$ syncthing serve
```

Note: Add a .stignore file at the root of your folders to ignore [some file patterns](https://developerinsider.co/syncthing-stignore-examples-ignore-files-by-extension-folder-pattern-type/)

```
.DS_Store       # macOS Finder metadata
Thumbs.db       # Windows thumbnails
desktop.ini     # Windows folder settings
.Trash-*        # Linux trash
$RECYCLE.BIN    # Windows recycle bin

node_modules/   # Node.js dependencies
.git/           # Git repository data
.vscode/        # VS Code settings
.idea/          # IntelliJ IDEA settings
__pycache__/    # Python cache
*.pyc           # Python compiled files
build/          # Build directories
dist/           # Distribution directories
```

3. Enable and make the syncthing service autostart for your User

```bash
sudo systemctl enable --user syncthing
sudo systemctl start --user syncthing
```

## Pairing a Device (Example: Android Phone)

1.  Install the Syncthing app on your phone.
2.  In the phone app, click the **+** or **Add Device** button.
3.  Scan the QR code shown on SKYLAB's "Show ID" screen or type the ID manually.
4.  Give it a name (e.g., "SKYLAB") and save.
5.  On SKYLAB's Web GUI, a notification will appear: "Device X wants to connect". Click **Add Device**.

## Syncing a Folder

1.  On your device (e.g., Phone), create or select a folder to sync.
2.  In the folder settings, go to the **Sharing** tab and check **SKYLAB**.
3.  On SKYLAB's Web GUI, a notification will appear: "Device X wants to share folder Y".
4.  Click **Add**.
5.  Choose the path on SKYLAB where you want the files to be stored (e.g., `/home/johndoe/Sync/PhonePhotos`).
6.  Files will start syncing immediately.
