# Syncthing

Syncthing is used to synchronize files between SKYLAB and other devices (Laptops, Phones) in a decentralized and secure way.

## Configuration Reference (NixOS 25.11)

The complete list of available options for the `services.syncthing` module can be found in the [official NixOS Options Search](https://search.nixos.org/options?channel=25.11&query=services.syncthing).

### Parameters Table

| Parameter | Default Value | Description |
| :--- | :--- | :--- |
| `enable` | `false` | Whether to enable the Syncthing service. |
| `user` | `"syncthing"` | User account under which Syncthing runs. |
| `group` | `"syncthing"` | Group under which Syncthing runs. |
| `hostname` | `config.networking.hostName` | Hostname for the local device. |
| `dataDir` | `"/var/lib/syncthing"` | Default path for synchronized folders. |
| `configDir` | `dataDir` | Directory for `config.xml` and keys. |
| `databaseDir` | `configDir` | Directory for the database. |
| `guiAddress` | `"127.0.0.1:8384"` | Address for the web interface. |
| `openDefaultPorts` | `false` | Open 22000 (TCP/UDP) and 21027 (UDP). |
| `overrideDevices` | `true` | Overwrite WebUI devices with Nix settings. |
| `overrideFolders` | `true` | Overwrite WebUI folders with Nix settings. |
| `settings` | `{ }` | Declarative configuration (devices, folders, etc.). |
| `extraArgs` | `[ ]` | Extra CLI arguments for the binary. |
| `package` | `pkgs.syncthing` | The Syncthing package to use. |
| `systemService` | `true` | Create a systemd system service. |

### Troubleshooting: Unknown flag `--no-default-folder`

In Syncthing v2.x (Hafnium Hornet), the flag `--no-default-folder` has been removed. NixOS modules (especially in 25.11) may attempt to pass this flag to enforce a purely declarative setup. If you encounter a startup failure with an "unknown flag" error, ensure that `extraArgs` is empty or does not contain this flag. 

*Note: Declarative folders are managed via `services.syncthing.settings.folders`.*

## Full Configuration Template

You can use this template in `modules/services/syncthing.nix` to configure the service exhaustively:

```nix
{ config, pkgs, ... }: {
  services.syncthing = {
    enable = true;
    user = "zipang";
    group = "users";
    dataDir = "/home/zipang";
    configDir = "/home/zipang/.config/syncthing";
    databaseDir = "/home/zipang/.config/syncthing";
    guiAddress = "127.0.0.1:8384";
    overrideDevices = true;
    overrideFolders = true;
    
    settings = {
      devices = {
        "DEVICE-NAME" = { id = "DEVICE-ID"; };
      };
      folders = {
        "folder-label" = {
          path = "/path/to/folder";
          devices = [ "DEVICE-NAME" ];
        };
      };
      options = {
        urAccepted = -1; # Disable usage reporting
      };
    };
  };
}
```

## Initial Setup

Since we rely on SSH keys for security, the Syncthing GUI is only accessible via an SSH tunnel.

1.  **Create an SSH Tunnel**:
    From your laptop, run:
    ```bash
    ssh -L 8384:localhost:8384 zipang@<SKYLAB_IP>
    ```
2.  **Access the Web GUI**:
    Open your browser and navigate to `http://localhost:8384`.
3.  **Identify SKYLAB**:
    Go to **Actions > Show ID**. This is the unique identifier you will need to add SKYLAB to your other devices.

## Pairing a Device (Example: Android Phone)

1.  Install the Syncthing app on your phone.
2.  In the phone app, click the **+** or **Add Device** button.
3.  Scan the QR code shown on SKYLAB's "Show ID" screen or type the ID manually.
4.  Give it a name (e.g., "SKYLAB") and save.
5.  On SKYLAB's Web GUI, a notification will appear: "Device X wants to connect". Click **Add Device**.

## Syncing a Folder

1.  On your device (e.g., Phone), create or select a folder to sync.
2.  In the folder settings, go to the **Sharing** tab and check **SKYLAB**.
3.  On SKYLAB's Web GUI, a notification will appear: "Device X wants to share folder Y".
4.  Click **Add**.
5.  Choose the path on SKYLAB where you want the files to be stored (e.g., `/home/zipang/Sync/PhonePhotos`).
6.  Files will start syncing immediately.
