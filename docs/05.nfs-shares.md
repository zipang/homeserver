# NFS Shared Drives

## Goal

We want to share the server's storage using NFS (Network File System) to provide high-performance file access for Linux-to-Linux connections. This complements our SAMBA setup and allows for comparative performance testing.

## Configuration

### Storage Structure
The NFS export uses the same stable structure as SAMBA:
- **Root Export**: `/share` (configured as NFSv4 pseudo-root with `fsid=0`)
- **Data Tree**: `/share/Skylab/[Documents, Games, Music, Pictures]` (bind-mounted from user home directories)

### NFS Service (`modules/services/nfs.nix`)
The NFS server is configured for the local network (192.168.1.0/24):
- **NFSv4**: Standard port 2049 is opened in the firewall.
- **Pseudo-root**: `/share` is the entry point. Clients mounting `SKYLAB:/` will see the `Skylab` directory.
- **Options**:
    - `rw`: Read-Write access.
    - `crossmnt`: Allows clients to move from the pseudo-root into sub-mounts automatically.
    - `nohide`: Ensures that the bind-mounted directories under `/share/Skylab` are visible to clients.

## How to Access

### Linux CLI
To mount the entire Skylab share:
```bash
sudo mkdir -p /mnt/skylab
sudo mount -t nfs4 skylab.local:/Skylab /mnt/skylab
```

To mount the root export (showing all shares under `/share`):
```bash
sudo mount -t nfs4 skylab.local:/ /mnt/path
```

### Automatic Mount (/etc/fstab)
Add the following to your client's `/etc/fstab`:
```fstab
skylab.local:/Skylab  /mnt/skylab  nfs4  rw,user,noauto,x-systemd.automount,x-systemd.idle-timeout=600 0 0
```

## Performance Testing (NFS vs Samba)

To compare the performance between the two protocols, you can use `fio` or simple `rsync` / `dd` tests.

### Simple Write Test
```bash
# Samba
dd if=/dev/zero of=/mnt/samba/testfile bs=1M count=1024 conv=fdatasync

# NFS
dd if=/dev/zero of=/mnt/nfs/testfile bs=1M count=1024 conv=fdatasync
```

### Simple Read Test
```bash
# Clear cache before each test if possible (requires sudo on client)
# sudo sh -c 'echo 3 > /proc/sys/vm/drop_caches'

# Samba
time cp /mnt/samba/testfile /dev/null

# NFS
time cp /mnt/nfs/testfile /dev/null
```

## Maintenance

Check the status of the NFS server:
```bash
systemctl status nfs-server
```

View active exports:
```bash
sudo exportfs -v
```
