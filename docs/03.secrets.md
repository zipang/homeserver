# Secrets Management

## Goal

To securely store and manage sensitive information (like API tokens, passwords, and private keys) within our public Git repository. We use `sops` (Secrets OPerationS) with `age` encryption to ensure that secrets are only accessible by the server and authorized administrators.

## How it works

1.  **Encryption**: Secrets are stored as binary blobs in the `secrets/` directory.
2.  **Access**:
    *   **Admins**: Use a private `age` key on their local machine to edit/view secrets.
    *   **Server**: Uses its own SSH host key (`/etc/ssh/ssh_host_ed25519_key`) to decrypt secrets at runtime.
3.  **In-place binary mode**: We encrypt the entire file (e.g., `.env`, `.json`) as a binary blob. This hides not only the values but also the keys and the file structure.

## Setup Instructions

### 1. Generate your Admin Key
If you don't have an `age` key yet, generate one on your local machine:
```bash
nix-shell -p age --run "age-keygen -o ~/.config/sops/age/keys.txt"
```
Then, extract your public key:
```bash
cat ~/.config/sops/age/keys.txt | grep "public key"
```

### 2. Configure SOPS
Add your public key to the `.sops.yaml` file in the repository root:
```yaml
creation_rules:
  - path_regex: secrets/[^/]+\.(yaml|json|env|ini)$
    # ...
    key_groups:
      - age:
        - "age1your_public_key_here" # Your Admin Key
        - "age1server_public_key_here" # Server SSH-to-age Key
```

### 3. Get the Server's Public Key
To allow the server to decrypt the secrets, you need its `age` equivalent of the SSH host key. Run this on the server:
```bash
nix-shell -p ssh-to-age --run "ssh-to-age < /etc/ssh/ssh_host_ed25519_key.pub"
```
Add the output to `.sops.yaml`.

## Usage Example

### 1. Create a secret file
Create a standard environment file (e.g., `secrets/jellyfin.env`):
```env
JELLYFIN_API_KEY=my_secret_token
```

### 2. Encrypt the file
Use the `secrets` management script provided in the repository:
```bash
./scripts/secrets encrypt secrets/jellyfin.env
```
The file is now an encrypted binary blob. You can safely commit it to Git.

### 3. Use in NixOS
Declare the secret in your module (e.g., `modules/services/jellyfin.nix`):
```nix
{ config, ... }:
{
  sops.secrets."jellyfin.env" = {
    sopsFile = ../../secrets/jellyfin.env;
    format = "binary";
  };

  systemd.services.jellyfin.serviceConfig.EnvironmentFile = config.sops.secrets."jellyfin.env".path;
}
```

## Management Script Commands
The `./scripts/secrets` script simplifies common tasks:
*   `./scripts/secrets encrypt <file>`: Encrypt a new or updated file in-place.
*   `./scripts/secrets edit <file>`: Open an encrypted file in your `$EDITOR`. Re-encrypts automatically on save.
*   `./scripts/secrets decrypt <file>`: View the decrypted content in the terminal.
