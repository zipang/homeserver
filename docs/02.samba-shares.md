# SAMBA Shared Drives

## Goal

We want to share the server's storage as a single, easily discoverable root folder on the local network. This replaces previous attempts with NFS and simplifies access for MacOS, Linux, and Windows clients.

## Configuration

### Storage Structure
The storage is based on a BTRFS drive labeled `MEDIAS`. To ensure stability and avoid race conditions during boot, we use a two-layer mounting strategy:

1.  **Primary Mounts**: BTRFS subvolumes are mounted to the user's home directory.
    - `/home/zipang/[Documents, Games, Music, Pictures, Workspace]`
2.  **Bind Mounts**: The share tree mirrors these directories using `bind` mounts.
    - `/share/Skylab/[Documents, Games, Music, Pictures]`

This structure provides a single source of truth while consolidating all media into a unified entry point for network sharing. The `/share/Skylab/*` mounts are configured with `nofail` and explicit dependencies on the primary mounts to guarantee system availability.

### SAMBA Service (`modules/services/samba.nix`)
The Samba configuration is optimized for home use with the following settings:

- **Share Name**: `Skylab`
- **Security**: User-based security, but with "bad user" mapping to guest.
- **Guest Access**: Enabled and mapped to the `zipang` user. This allows family members to access files without complex credential management while ensuring files are created with the correct permissions.
- **Force User**: All operations on the share are performed as the `zipang` user.

### Discovery Services

To ensure the server is "plug and play" on the network, we enable two discovery protocols:

1.  **Avahi (mDNS/DNS-SD)**:
    - Used by **MacOS** and **Linux** clients.
    - Resolves the server as `SKYLAB.local`.
    - Automatically displays the server in the Finder/File Manager sidebar.
    - Includes a `_device-info._tcp` record to show a custom "Mac" icon for better visual integration.

2.  **WSDD (Web Services Dynamic Discovery)**:
    - Used by **modern Windows** (10/11) and some Linux clients.
    - Ensures "SKYLAB" appears under the "Network" section in Windows File Explorer.

## How to Access

- **MacOS**: Open Finder, look for `SKYLAB` in the sidebar, or use `Cmd+K` and enter `smb://skylab.local/Skylab`.
- **Windows**: Open File Explorer, go to `Network`, or enter `\\SKYLAB\Skylab` in the address bar.
- **Linux**: 
    - Use your file manager's "Network" section.
    - Or mount via CLI: `mount -t cifs //skylab.local/Skylab /mnt/path -o guest`.
    - Or add to `/etc/fstab` (requires `cifs-utils`):
      ```fstab
      # Example: No auto-mount at boot, but mounts on first access
      //skylab.local/Skylab  /mnt/skylab  cifs  guest,uid=1000,iocharset=utf8,noauto,x-systemd.automount 0 0
      ```

## Maintenance

To check the status of the Samba service on the host:
```bash
systemctl status samba-smbd
```

To view active connections:
```bash
smbstatus
```
