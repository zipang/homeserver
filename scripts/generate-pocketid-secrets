#!/usr/bin/env bash

# generate-pocketid-secrets
# Generates Pocketid environment secrets and configuration file.
# Should be run with sudo on the SKYLAB server.

SECRETS_DIR="/var/lib/secrets"
SECRET_FILE="$SECRETS_DIR/pocketid.env"
POCKETID_USER="pocketid"
POCKETID_GROUP="pocketid"

# Ensure we are running as root
if [ "$EUID" -ne 0 ]; then
  echo "‚ùå Please run as root (use sudo)"
  exit 1
fi

# Detect if pocketid user exists (may not exist until first nixos-rebuild)
USER_EXISTS=false
if id "$POCKETID_USER" &>/dev/null && getent group "$POCKETID_GROUP" &>/dev/null; then
    USER_EXISTS=true
    echo "üë§ Using identified user/group: $POCKETID_USER:$POCKETID_GROUP"
else
    echo "‚ö†Ô∏è  User '$POCKETID_USER' or group '$POCKETID_GROUP' not found yet."
    echo "   This is normal before the first nixos-rebuild with pocketid module enabled."
    echo "   Re-run this script after 'sudo nixos-rebuild switch' completes."
fi

# 1. Ensure directory exists
if [ ! -d "$SECRETS_DIR" ]; then
    echo "üìÅ Creating directory $SECRETS_DIR..."
    mkdir -p "$SECRETS_DIR"
    chmod 755 "$SECRETS_DIR"
fi

# 2. Check if file already exists
if [ -f "$SECRET_FILE" ]; then
    echo "‚úÖ Pocketid environment file already exists at $SECRET_FILE."
    read -p "Do you want to regenerate it? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 0
    fi
    echo "‚ö†Ô∏è  Backing up existing file to $SECRET_FILE.bak"
    cp "$SECRET_FILE" "$SECRET_FILE.bak"
fi

echo ""
echo "üîê Pocketid Secrets Generation"
echo "========================================================================"
echo ""

# 3. Generate encryption key
echo "Generating encryption key for Pocketid..."
ENCRYPTION_KEY=$(openssl rand -base64 32)
if [ -z "$ENCRYPTION_KEY" ]; then
    echo "‚ùå Error: Failed to generate encryption key."
    exit 1
fi
echo "‚úÖ Encryption key generated (32 bytes, base64-encoded)"
echo ""

# 4. Create the environment file
# Note: Non-sensitive configuration like DB_CONNECTION_STRING is handled in the Nix module settings.
cat > "$SECRET_FILE" <<EOF
# Pocketid Sensitive Configuration File
# Generated $(date '+%Y-%m-%d %H:%M:%S')

# Encryption key for sensitive data (REQUIRED)
ENCRYPTION_KEY=$ENCRYPTION_KEY
EOF

# 8. Set proper ownership and permissions
if [ "$USER_EXISTS" = true ]; then
    chown "$POCKETID_USER:$POCKETID_GROUP" "$SECRET_FILE"
else
    chown root:root "$SECRET_FILE"
fi
chmod 600 "$SECRET_FILE"

echo "========================================================================"
echo "‚úÖ Pocketid environment file created at: $SECRET_FILE"
echo ""
echo "üìã Summary:"
echo "  ‚Ä¢ Encryption Key: Generated and saved"
echo "  ‚Ä¢ Database User: pocketid (Peer Authentication)"
echo ""
echo "üîç Testing PostgreSQL Connection..."
if id "pocketid" &>/dev/null; then
    if sudo -u "pocketid" psql -d "pocketid" -c "SELECT 1;" &>/dev/null; then
        echo "‚úÖ Database connection successful!"
    else
        echo "‚ùå Database connection failed. Please ensure PostgreSQL is running"
        echo "   and 'nixos-rebuild switch' has been applied."
        echo "   (Checked connection for user 'pocketid' on database 'pocketid')"
    fi
else
    echo "‚ö†Ô∏è  User 'pocketid' not found yet. Cannot test connection."
fi

echo ""
echo "‚ö†Ô∏è  IMPORTANT NEXT STEPS:"
echo ""
echo "1Ô∏è‚É£  If the pocketid user doesn't exist yet (didn't find it), you must:"
echo "   ‚Ä¢ Apply the NixOS configuration: sudo nixos-rebuild switch --flake .#SKYLAB"
echo "   ‚Ä¢ Then re-run this script to fix ownership: sudo $(basename $0)"
echo ""
echo "2Ô∏è‚É£  After everything is set up, access the admin interface at:"
echo "   üåê https://pocketid.skylab.local/setup"
echo ""
echo "========================================================================"
