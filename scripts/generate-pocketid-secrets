#!/usr/bin/env bash

# generate-pocketid-secrets
# Generates Pocketid environment secrets and configuration file.
# Should be run with sudo on the SKYLAB server.

SECRETS_DIR="/var/lib/secrets"
SECRET_FILE="$SECRETS_DIR/pocketid.env"
POCKETID_USER="pocket-id"
POCKETID_GROUP="pocket-id"

# Ensure we are running as root
if [ "$EUID" -ne 0 ]; then
  echo "âŒ Please run as root (use sudo)"
  exit 1
fi

# Detect if pocket-id user exists (may not exist until first nixos-rebuild)
USER_EXISTS=false
if id "$POCKETID_USER" &>/dev/null && getent group "$POCKETID_GROUP" &>/dev/null; then
    USER_EXISTS=true
    echo "ðŸ‘¤ Using identified user/group: $POCKETID_USER:$POCKETID_GROUP"
else
    echo "âš ï¸  User '$POCKETID_USER' or group '$POCKETID_GROUP' not found yet."
    echo "   This is normal before the first nixos-rebuild with pocketid module enabled."
    echo "   Re-run this script after 'sudo nixos-rebuild switch' completes."
fi

# 1. Ensure directory exists
if [ ! -d "$SECRETS_DIR" ]; then
    echo "ðŸ“ Creating directory $SECRETS_DIR..."
    mkdir -p "$SECRETS_DIR"
    chmod 700 "$SECRETS_DIR"
fi

# 2. Check if file already exists
if [ -f "$SECRET_FILE" ]; then
    echo "âœ… Pocketid environment file already exists at $SECRET_FILE."
    read -p "Do you want to regenerate it? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 0
    fi
    echo "âš ï¸  Backing up existing file to $SECRET_FILE.bak"
    cp "$SECRET_FILE" "$SECRET_FILE.bak"
fi

echo ""
echo "ðŸ” Pocketid Secrets Generation"
echo "========================================================================"
echo ""

# 3. Generate encryption key
echo "Generating encryption key for Pocketid..."
ENCRYPTION_KEY=$(openssl rand -base64 32)
if [ -z "$ENCRYPTION_KEY" ]; then
    echo "âŒ Error: Failed to generate encryption key."
    exit 1
fi
echo "âœ… Encryption key generated (32 bytes, base64-encoded)"
echo ""

# 4. Prompt for database password
echo "ðŸ—„ï¸  Database Configuration:"
read -p "Enter PostgreSQL password for 'pocketid' user (press Enter for auto-generated): " DB_PASSWORD

if [ -z "$DB_PASSWORD" ]; then
    DB_PASSWORD=$(openssl rand -base64 16 | tr -d '=' | cut -c 1-20)
    echo "âœ… Auto-generated password: $DB_PASSWORD"
else
    echo "âœ… Using provided password"
fi
echo ""

# 5. Confirm the APP_URL
DEFAULT_URL="https://pocketid.skylab.local"
read -p "Enter Pocketid public URL (press Enter for default: $DEFAULT_URL): " APP_URL
APP_URL="${APP_URL:-$DEFAULT_URL}"
echo "âœ… Using URL: $APP_URL"
echo ""

# 6. Confirm session duration
DEFAULT_SESSION=60
read -p "Session duration in minutes (press Enter for default: $DEFAULT_SESSION): " SESSION_DURATION
SESSION_DURATION="${SESSION_DURATION:-$DEFAULT_SESSION}"
echo "âœ… Session duration: $SESSION_DURATION minutes"
echo ""

# 7. Create the environment file
cat > "$SECRET_FILE" <<EOF
# Pocketid Configuration File
# Generated $(date '+%Y-%m-%d %H:%M:%S')

# The URL where Pocketid will be accessed from the network
APP_URL=$APP_URL

# Encryption key for sensitive data (REQUIRED)
# This key encrypts private keys and other sensitive data
# Generated via: openssl rand -base64 32
ENCRYPTION_KEY=$ENCRYPTION_KEY

# Database connection string
# Using local PostgreSQL connection with default port 5432
# Password must match the PostgreSQL pocketid user password
FILE_BACKEND=database
DB_CONNECTION_STRING=postgresql://pocketid:$DB_PASSWORD@localhost:5432/pocketid

# Service configuration
TRUST_PROXY=true
PORT=1411
HOST=127.0.0.1

# User signup policy
# Disable public signups - only admin can create users
ALLOW_USER_SIGNUPS=disabled

# Logging configuration
LOG_LEVEL=info

# UI Configuration
UI_CONFIG_DISABLED=false
APP_NAME=SKYLAB Pocketid
SESSION_DURATION=$SESSION_DURATION
HOME_PAGE_URL=/settings/account
EMAILS_VERIFIED=false
ALLOW_OWN_ACCOUNT_EDIT=true
EOF

# 8. Set proper ownership and permissions
if [ "$USER_EXISTS" = true ]; then
    chown "$POCKETID_USER:$POCKETID_GROUP" "$SECRET_FILE"
else
    chown root:root "$SECRET_FILE"
fi
chmod 600 "$SECRET_FILE"

echo "========================================================================"
echo "âœ… Pocketid environment file created at: $SECRET_FILE"
echo ""
echo "ðŸ“‹ Summary:"
echo "  â€¢ Encryption Key: Generated and saved"
echo "  â€¢ Database Password: $DB_PASSWORD"
echo "  â€¢ Public URL: $APP_URL"
echo "  â€¢ Session Duration: $SESSION_DURATION minutes"
echo ""
echo "âš ï¸  IMPORTANT NEXT STEPS:"
echo ""
echo "1ï¸âƒ£  The database password needs to be set in PostgreSQL:"
echo ""
echo "   sudo -u postgres psql -c \"ALTER USER pocketid WITH PASSWORD '$DB_PASSWORD';\""
echo ""
echo "2ï¸âƒ£  If the pocket-id user doesn't exist yet (didn't find it), you must:"
echo "   â€¢ Apply the NixOS configuration: sudo nixos-rebuild switch --flake .#SKYLAB"
echo "   â€¢ Then re-run this script to fix ownership: sudo $(basename $0)"
echo ""
echo "3ï¸âƒ£  After everything is set up, access the admin interface at:"
echo "   ðŸŒ $APP_URL/setup"
echo ""
echo "========================================================================"
