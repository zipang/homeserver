#!/usr/bin/env bash

# generate-pocketid-secrets
# Generates Pocketid environment secrets and configuration file.
# Should be run with sudo on the SKYLAB server.

SECRETS_DIR="/var/lib/secrets"
SECRET_FILE="$SECRETS_DIR/pocketid.env"
POCKETID_USER="pocket-id"
POCKETID_GROUP="pocket-id"

# Ensure we are running as root
if [ "$EUID" -ne 0 ]; then
  echo "‚ùå Please run as root (use sudo)"
  exit 1
fi

# Detect if pocket-id user exists (may not exist until first nixos-rebuild)
USER_EXISTS=false
if id "$POCKETID_USER" &>/dev/null && getent group "$POCKETID_GROUP" &>/dev/null; then
    USER_EXISTS=true
    echo "üë§ Using identified user/group: $POCKETID_USER:$POCKETID_GROUP"
else
    echo "‚ö†Ô∏è  User '$POCKETID_USER' or group '$POCKETID_GROUP' not found yet."
    echo "   This is normal before the first nixos-rebuild with pocketid module enabled."
    echo "   Re-run this script after 'sudo nixos-rebuild switch' completes."
fi

# 2. Check if file already exists
if [ -f "$SECRET_FILE" ]; then
    echo "‚úÖ Pocketid environment file already exists at $SECRET_FILE."
    read -p "Do you want to regenerate it? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 0
    fi
    echo "‚ö†Ô∏è  Backing up existing file to $SECRET_FILE.bak"
    cp "$SECRET_FILE" "$SECRET_FILE.bak"
fi

echo ""
echo "üîê Pocketid Secrets Generation"
echo "========================================================================"
echo ""

# 3. Generate encryption key
echo "Generating encryption key for Pocketid..."
ENCRYPTION_KEY=$(openssl rand -base64 32)
if [ -z "$ENCRYPTION_KEY" ]; then
    echo "‚ùå Error: Failed to generate encryption key."
    exit 1
fi
echo "‚úÖ Encryption key generated (32 bytes, base64-encoded)"
echo ""

# 4. Prompt for database configuration
echo "üóÑÔ∏è  Database Configuration:"
echo "Pocketid will connect via Unix socket as the user 'pocket-id' (no password needed)."
echo ""

# 5. Confirm the APP_URL
DEFAULT_URL="https://pocketid.skylab.local"
read -p "Enter Pocketid public URL (press Enter for default: $DEFAULT_URL): " APP_URL
APP_URL="${APP_URL:-$DEFAULT_URL}"
echo "‚úÖ Using URL: $APP_URL"
echo ""

# 6. Confirm session duration
DEFAULT_SESSION=60
read -p "Session duration in minutes (press Enter for default: $DEFAULT_SESSION): " SESSION_DURATION
SESSION_DURATION="${SESSION_DURATION:-$DEFAULT_SESSION}"
echo "‚úÖ Session duration: $SESSION_DURATION minutes"
echo ""

# 7. Create the environment file
cat > "$SECRET_FILE" <<EOF
# Pocketid Configuration File
# Generated $(date '+%Y-%m-%d %H:%M:%S')

# The URL where Pocketid will be accessed from the network
APP_URL=$APP_URL

# Encryption key for sensitive data (REQUIRED)
# This key encrypts private keys and other sensitive data
# Generated via: openssl rand -base64 32
ENCRYPTION_KEY=$ENCRYPTION_KEY

# Database connection string
# Using local PostgreSQL connection via Unix socket (Peer authentication)
# No password needed because system user name 'pocket-id' matches database user name.
FILE_BACKEND=database
DB_CONNECTION_STRING=postgresql:///pocket-id?host=/run/postgresql
# DB_CONNECTION_STRING=postgresql://pocket-id:PASSWORD@localhost:5432/pocket-id

# Service configuration
TRUST_PROXY=true
PORT=1411
HOST=127.0.0.1

# User signup policy
# Disable public signups - only admin can create users
ALLOW_USER_SIGNUPS=disabled

# Logging configuration
LOG_LEVEL=info

# UI Configuration
UI_CONFIG_DISABLED=false
APP_NAME=SKYLAB Pocketid
SESSION_DURATION=$SESSION_DURATION
HOME_PAGE_URL=/settings/account
EMAILS_VERIFIED=false
ALLOW_OWN_ACCOUNT_EDIT=true
EOF

# 8. Set proper ownership and permissions
if [ "$USER_EXISTS" = true ]; then
    chown "$POCKETID_USER:$POCKETID_GROUP" "$SECRET_FILE"
else
    chown root:root "$SECRET_FILE"
fi
chmod 600 "$SECRET_FILE"

echo "========================================================================"
echo "‚úÖ Pocketid environment file created at: $SECRET_FILE"
echo ""
echo "üìã Summary:"
echo "  ‚Ä¢ Encryption Key: Generated and saved"
echo "  ‚Ä¢ Database User: pocket-id (Peer Authentication)"
echo "  ‚Ä¢ Public URL: $APP_URL"
echo "  ‚Ä¢ Session Duration: $SESSION_DURATION minutes"
echo ""
echo "üîç Testing PostgreSQL Connection..."
if id "pocket-id" &>/dev/null; then
    if sudo -u "pocket-id" psql -d "pocket-id" -c "SELECT 1;" &>/dev/null; then
        echo "‚úÖ Database connection successful!"
    else
        echo "‚ùå Database connection failed. Please ensure PostgreSQL is running"
        echo "   and 'nixos-rebuild switch' has been applied."
    fi
else
    echo "‚ö†Ô∏è  User 'pocket-id' not found yet. Cannot test connection."
fi

echo ""
echo "‚ö†Ô∏è  IMPORTANT NEXT STEPS:"
echo ""
echo "1Ô∏è‚É£  If the pocket-id user doesn't exist yet (didn't find it), you must:"
echo "   ‚Ä¢ Apply the NixOS configuration: sudo nixos-rebuild switch --flake .#SKYLAB"
echo "   ‚Ä¢ Then re-run this script to fix ownership: sudo $(basename $0)"
echo ""
echo "2Ô∏è‚É£  After everything is set up, access the admin interface at:"
echo "   üåê $APP_URL/setup"
echo ""
echo "========================================================================"
