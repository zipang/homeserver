#!/usr/bin/env bash

# generate-acme-secrets
# Generates ACME Cloudflare token secret file by asking the user.
# Should be run with sudo on the server.

SECRETS_DIR="/var/lib/secrets/acme"
SECRET_FILE="$SECRETS_DIR/cloudflare_token"
ACME_USER="acme"
ACME_GROUP="nginx"

# Ensure we are running as root
if [ "$EUID" -ne 0 ]; then
  echo "âŒ Please run as root (use sudo)"
  exit 1
fi

# 1. Ensure directory exists with correct permissions
if [ ! -d "$SECRETS_DIR" ]; then
    echo "Creating directory $SECRETS_DIR..."
    mkdir -p "$SECRETS_DIR"
    chown "$ACME_USER:$ACME_GROUP" "$SECRETS_DIR"
    chmod 750 "$SECRETS_DIR"
fi

# 2. Ask for the token if it doesn't exist or if forced
if [ -f "$SECRET_FILE" ]; then
    echo "âœ… ACME Cloudflare token already exists at $SECRET_FILE."
    read -p "Do you want to overwrite it? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 0
    fi
fi

echo "ðŸ” Please enter your Cloudflare API Token (for DNS-01 challenge):"
read -s CLOUDFLARE_TOKEN
echo

if [ -z "$CLOUDFLARE_TOKEN" ]; then
    echo "âŒ Error: Token cannot be empty."
    exit 1
fi

echo "CLOUDFLARE_DNS_API_TOKEN=$CLOUDFLARE_TOKEN" > "$SECRET_FILE"
chown "$ACME_USER:$ACME_GROUP" "$SECRET_FILE"
chmod 640 "$SECRET_FILE"

echo "-------------------------------------------------------"
echo "ACME secrets are ready in $SECRET_FILE"
echo "-------------------------------------------------------"
