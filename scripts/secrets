#!/usr/bin/env bash
# Project secrets manager for in-place binary encryption
# Usage: ./scripts/secrets {encrypt|edit|decrypt} <file>

if ! command -v sops &> /dev/null; then
    echo "❌ Error: 'sops' command not found."
    echo "Please ensure sops is installed or run this script via nix-shell:"
    echo "  nix-shell -p sops --run \"./scripts/secrets $*\""
    exit 1
fi

# Use the hardcoded key as fallback if SOPS_AGE_KEY is not set
AGE_KEY="${SOPS_AGE_KEY:-age1xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx}"
SOPS_FLAGS="--age $AGE_KEY --input-type binary --output-type binary"

case $1 in
  encrypt)
    if [ ! -f "$2" ]; then
      echo "Error: File $2 not found"
      exit 1
    fi
    # Encrypts in-place safely
    sops $SOPS_FLAGS --encrypt "$2" > "$2.tmp" && mv "$2.tmp" "$2"
    echo "✅ Encrypted $2 in-place"
    ;;
  edit)
    if [ ! -f "$2" ]; then
      echo "Error: File $2 not found"
      exit 1
    fi
    # sops handles binary files by decrypting to a temp buffer
    sops $SOPS_FLAGS "$2"
    ;;
  decrypt)
    if [ ! -f "$2" ]; then
      echo "Error: File $2 not found"
      exit 1
    fi
    # Output to stdout
    sops $SOPS_FLAGS --decrypt "$2"
    ;;
  *)
    echo "Usage: $0 {encrypt|edit|decrypt} <file>"
    exit 1
    ;;
esac
