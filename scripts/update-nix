#!/usr/bin/env bash
set -e
BRANCH=${1:-master}
echo "ğŸš€ Starting SKYLAB System Update (Branch: $BRANCH)..."

echo "ğŸ”§ [0/4] Fixing repository permissions..."
cd /home/master/homeserver
# Ensure current user owns the directory to avoid git permission errors
sudo chown -R $USER:wheel .

echo "ğŸ“¥ [1/4] Pulling latest changes from Git..."
git fetch origin
git checkout "$BRANCH"
git pull origin "$BRANCH"

echo "ğŸ”„ [2/4] Updating Flake lockfile..."
nix flake update

echo "âš’ï¸  [3/4] Rebuilding NixOS system..."
sudo nixos-rebuild switch --impure --flake .#SKYLAB

echo "ğŸ“ [4/4] Checking for lockfile changes..."
if ! git diff --quiet flake.lock; then
  echo "ğŸ“¤ Pushing updated flake.lock to repository..."
  git add flake.lock
  git commit -m "chore: update flake.lock after system upgrade"
  git push origin "$BRANCH"
else
  echo "âœ… No changes to flake.lock. System is up to date."
fi

echo "âœ¨ Update complete!"
