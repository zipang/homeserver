# SKYLAB - A NixOS Home Server Experience

This repository contains the NixOS configuration for my home server.

To understand the repository structure and philosophy of NixOS with Flakes some preliminary readings can be useful : 

* [NixOS - Introduction to Flakes](https://nixos-and-flakes.thiscute.world/nixos-with-flakes/introduction-to-flakes)

## Repository Structure

```text
.
├── flake.nix               # Entry point for Nix Flake
├── hosts/                  # Host-specific configurations
│   └── SKYLAB/
│       ├── configuration.nix # Main configuration for SKYLAB
│       └── hardware-configuration.nix # Hardware-specific config (scanned from machine)
├── modules/                # Reusable NixOS modules
│   ├── programs/           # User programs (Neovim, Tmux)
│   ├── services/           # Services (NFS, Docker, etc.)
│   └── system/             # System settings (SSH, Core, Nix)
├── scripts/                # Custom management scripts
├── secrets/                # Encrypted secrets (sops)
└── docs/                   # Detailed documentation
```

## Manual Setup Requirements

Before deploying, ensure the following are handled manually on the SKYLAB server:

1.  **Hardware Config**: Copy the original `/etc/nixos/hardware-configuration.nix` into this repo under `hosts/SKYLAB/hardware-configuration.nix` to match your server's hardware (auto-generated by NixOS).
2.  **Passwords**: User passwords are not stored in Git. So after the first deployment, set them manually:
    ```bash
    sudo passwd $user
    ```
3.  **Trusted SSH Keys**: Place your authorized public keys in `/var/lib/secrets/ssh/authorized_keys`. These keys will be shared by all users.
    *Note: The directory `/var/lib/secrets/ssh` is automatically created by NixOS.*
4.  **GitHub Access**: Generate an SSH key on the server and add it to your GitHub account to enable syncing (see `docs/nixos-install.md`).

## How to use

1. **Preparation** (on the host)
  * Follow the instructions in [docs > nixos-install](./docs/nixos-install.md) to install NixOS on a new machine and sync the Flake configuration with this repo.

2. **Add new feature** (on any 'staging' machine)
  * Launch `opencode` to update the Flake configuration.
  * Commit and push changes to the repo.
 
3. **Apply Configuration** (on the host)
  * Use the `update-nix` script to pull and apply changes:
  ```bash
  update-nix [branch]
  ```

4. **Troubleshooting & Recovery**
  * **Emergency Mode / Boot Failure**: If the system fails to boot or `switch` hangs, find the cause in the failed boot's logs:
    ```bash
    journalctl --list-boots      # Find the index of the failed boot (usually -1)
    journalctl -b -1 -p err..alert # View errors from that boot
    ```
  * **Stuck Units**: If a service or mount unit is stuck and prevents `nixos-rebuild switch`, use `boot` instead of `switch` and restart:
    ```bash
    sudo nixos-rebuild boot --flake .#SKYLAB
    sudo reboot
    ```
    This prepares the new configuration to be activated cleanly from the next cold start.

## Documentation of individual services

Specific services have a dedicated documentation to explain their configuration in detail : 

* [NFS Shares](./docs/nfs-shares.md)
* [Samba Shares](./docs/samba-shares.md)
* [Syncthing](./docs/syncthing.md)
* [Nginx Reverse Proxy](./docs/nginx.md)
* [Fail2Ban Security](./docs/fail2ban.md)
* [Secrets Management](./docs/secrets.md)
* [Tmux](./docs/tmux.md)
* [Immich](./docs/immich.md)
* [Authelia SSO](./docs/authelia.md)
* [Nextcloud](./docs/nextcloud.md)
* [PostgreSQL (Global)](./docs/postgresql.md)
* [Redis (Global)](./docs/redis.md)
* [zrok (SSO & Tunnel)](./docs/zrok.md)
* [ZFS Storage](./docs/zfs-storage.md)
* [SSL/TLS Setup](./docs/ssl-setup.md)

## IMPORTANT: Note for LLM Agents

**Mandatory Reading for Agents:** Always read [AGENTS.md](./AGENTS.md) and if required [WORK IN PROGRESS](./WORK_IN_PROGRESS.md) when starting a new session to understand the project rules and current session state.
