# SKYLAB - A NixOS Home Server Experience

This repository contains the NixOS configuration for my home server.

To understand the repository structure and philosophy of NixOS with Flakes some preliminary readings can be useful : 

* [NixOS - Introduction to Flakes](https://nixos-and-flakes.thiscute.world/nixos-with-flakes/introduction-to-flakes)

## Repository Structure

```text
.
├── flake.nix               # Entry point for Nix Flake
├── hosts/                  # Host-specific configurations
│   └── SKYLAB/
│       ├── configuration.nix # Main configuration for SKYLAB
│       └── hardware-configuration.nix # Hardware-specific config (scanned from machine)
├── modules/                # Reusable NixOS modules
│   ├── services/           # Services (NFS, Docker, etc.)
│   └── system/             # System settings (SSH, Core, Nix)
└── docs/                   # Detailed documentation
```

## Manual Setup Requirements

Before deploying, ensure the following are handled manually on the SKYLAB server:

1.  **SSH Keys**: Place your authorized public keys in `/etc/nixos/ssh/authorized_keys`. These keys will be shared by all users.
2.  **Passwords**: User passwords are not stored in Git. So after the first deployment, set them manually:
    ```bash
    sudo passwd $user
    ```
3.  **Disk Labels**: Your storage drive must be labeled `MEDIAS` and your swap partition `SWAP`.
4.  **Hardware Config**: Copy the original `/etc/nixos/hardware-configuration.nix` into this repo under `hosts/SKYLAB/hardware-configuration.nix` to match your server's hardware (auto-generated by NixOS).
5.  **GitHub Access**: Generate an SSH key on the server and add it to your GitHub account to enable syncing (see `docs/install.md`).

## How to use

1. Preparation (on the host)
  * Follow the instructions in [docs > install](./docs/install.md) to install NixOS on a new machine and sync the Flake configuration with this repo.

2. Add new feature (on any 'staging' machine inside a clone of this git repository)
  * Launch `opencode` and switch between PLAN and BUILD mode to update the Flake configuration.
  * commit and push changes to the repo
 
3. Apply Configuration (on the host)
  * A script has been added to apply any new configuration (pull changes from the github repo, build and re-push `flake.lock`):
  ```bash
  update-nix [branch]
  ```

## Secrets Management

We use `sops` with `age` for secrets management. Secrets are stored in the `secrets/` directory as binary-encrypted files.

### 1. Prerequisite: Age Key
You must have an `age` key to encrypt/decrypt secrets. The public key must be added to `.sops.yaml`.
The server uses its SSH host key (`/etc/ssh/ssh_host_ed25519_key`) for decryption.

### 2. Workflow
1.  **Create/Update a secret**: Create a file (e.g., `secrets/service.env`) with your secrets.
2.  **Encrypt**: Run the management script to encrypt it in-place:
    ```bash
    ./scripts/secrets encrypt secrets/service.env
    ```
3.  **Configure**: Add the secret to `modules/system/sops.nix`.
4.  **Use**: Reference the secret in your service configuration:
    ```nix
    systemd.services.myservice.serviceConfig.EnvironmentFile = config.sops.secrets."service.env".path;
    ```

### 3. Management Script
The `scripts/secrets` wrapper simplifies the commands:
*   `./scripts/secrets encrypt <file>`: Encrypts a file in-place.
*   `./scripts/secrets edit <file>`: Opens an encrypted file for editing.
*   `./scripts/secrets decrypt <file>`: Displays the decrypted content.

## IMPORTANT: Note for LLM Agents

**Mandatory Reading for Agents:** Always read [AGENTS.md](./AGENTS.md) and [.pending_session.context.md](./.pending_session.context.md) when starting a new session to understand the project rules and current session state.
