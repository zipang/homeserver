# Session Context: Transition to agenix for Secret Management

**Objective**: Replace plaintext password files (referenced via `passwordFile`) with encrypted secrets managed by `agenix`, using existing SSH keys for decryption.

## 1. Current Progress
- [x] **copyparty** service implemented in `modules/services/copyparty.nix`.
- [x] **Firewall** decentralized: ports managed within respective service modules.
- [x] **Host Configuration** updated to import the new `copyparty` module.
- [x] **Documentation** updated in `AGENTS.md`.

## 2. The `agenix` Integration Plan
1.  **Update `flake.nix`**: Add `github:ryantm/agenix` to `inputs` and pass it to `outputs`.
2.  **Create `secrets/secrets.nix`**: Define the mapping of encrypted files to public keys (User and Host).
    *   *Required Information*: User Public SSH Key (`ssh-ed25519 ...`) and SKYLAB Host Public Key (`/etc/ssh/ssh_host_ed25519_key.pub`).
3.  **Encrypt the Secret**: User runs `nix run github:ryantm/agenix -- -e secrets/copyparty-zipang.age` to create the encrypted payload.
4.  **Configure agenix in NixOS**:
    *   Update `hosts/SKYLAB/default.nix` to include `agenix.nixosModules.default`.
    *   Update `modules/services/copyparty.nix` to define the secret:
        ```nix
        age.secrets.copyparty-zipang.file = ../../secrets/copyparty-zipang.age;
        services.copyparty.accounts.zipang.passwordFile = config.age.secrets.copyparty-zipang.path;
        ```
5.  **Deployment**: Run `update-nix` (which already uses `--impure`).

## 3. Pending Information
- [ ] User Public SSH Key.
- [ ] SKYLAB Host Public Key.
